<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="icon-512.png" type="image/png">
<link rel="apple-touch-icon" href="icon-512.png">
<meta name="theme-color" content="#2c3e50">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juliu's Special 5 - Smart Sort</title>
    <style>
        :root {
            --bg-body: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-container: white;
            --text-main: #2c3e50;
            --bg-task: #f9f9f9;
        }

        body.dark-mode {
            --bg-body: #1a1a2e;
            --bg-container: #16213e;
            --text-main: #e9ecef;
            --bg-task: #0f3460;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); min-height: 100vh; padding: 10px; color: var(--text-main); transition: all 0.3s; }
        .container { max-width: 600px; margin: 0 auto; background: var(--bg-container); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; position: relative; }
        .dark-mode-toggle { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; }

        .tabs { display: flex; background: #34495e; overflow-x: auto; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { flex: 1; min-width: 120px; padding: 15px; background: #34495e; color: white; border: none; cursor: pointer; position: relative; border-right: 1px solid #2c3e50; }
        .tab.active { background: #2c3e50; border-bottom: 3px solid #3498db; }
        
        .tab-count { background: #e74c3c; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; font-weight: bold; }

        .content { padding: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .priority-buttons { display: flex; gap: 5px; }
        .priority-btn { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .priority-btn.selected { border-color: #3498db; transform: scale(1.1); box-shadow: 0 0 8px rgba(0,0,0,0.3); }
        .priority-btn-1 { background: #e74c3c; }
        .priority-btn-2 { background: #f39c12; }
        .priority-btn-3 { background: #27ae60; }
        
        .task-input { flex: 1; padding: 10px; border-radius: 5px; border: 2px solid #bdc3c7; background: var(--bg-container); color: var(--text-main); font-size: 16px; }
        .add-btn { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; margin-bottom: 20px; }

        .task { background: var(--bg-task); border-radius: 8px; margin-bottom: 10px; position: relative; overflow: hidden; border-left: 5px solid #ccc; transition: transform 0.3s ease; }
        .task-bar { height: 100%; position: absolute; left: 0; top: 0; opacity: 0.2; z-index: 1; transition: width 0.4s ease; }
        
        .priority-1 { border-left-color: #e74c3c; } .priority-1 .task-bar { background: #e74c3c; }
        .priority-2 { border-left-color: #f39c12; } .priority-2 .task-bar { background: #f39c12; }
        .priority-3 { border-left-color: #27ae60; } .priority-3 .task-bar { background: #27ae60; }

        .task-content { padding: 12px; display: flex; align-items: center; gap: 10px; position: relative; z-index: 2; }
        .task-text { flex: 1; font-size: 15px; font-weight: 500; }
        .task-text.completed { text-decoration: line-through; opacity: 0.5; }

        .btn-action { border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; color: white; font-weight: bold; }
        .btn-edit { background: #f39c12; }
        .btn-delete { background: #e74c3c; }

        .separator { text-align: center; margin: 25px 0 15px; border-bottom: 2px dashed #bdc3c7; line-height: 0.1em; }
        .separator span { background: var(--bg-container); padding: 0 15px; color: #95a5a6; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .no-tasks { text-align: center; color: #95a5a6; padding: 20px; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <button class="dark-mode-toggle" onclick="App.toggleDarkMode()">ðŸŒ“</button>
        <h1>Juliu's Special 5</h1>
        <div class="datetime" id="datetime">...</div>
    </div>
    <div class="tabs" id="tabs"></div>
    <div class="content" id="content"></div>
</div>

<audio id="audioSuccess" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
const App = {
    tabs: [{name: 'Principal', tasks: []}],
    activeTab: 0,
    selectedPriority: 2,
    isDarkMode: false,

    init() {
        this.loadFromStorage();
        if(this.isDarkMode) document.body.classList.add('dark-mode');
        this.renderTabs();
        this.updateDateTime();
        setInterval(() => this.updateDateTime(), 1000);
        this.checkMorningNotification();
    },

    toggleDarkMode() {
        this.isDarkMode = !this.isDarkMode;
        document.body.classList.toggle('dark-mode');
        this.saveToStorage();
    },

    checkMorningNotification() {
        const lastCheck = localStorage.getItem('js5_last_notif');
        const today = new Date().toDateString();
        if (lastCheck !== today) {
            let total = 0, critical = 0;
            this.tabs.forEach(tab => {
                tab.tasks.forEach(t => { if(t.progress < 100) { total++; if(t.priority === 1) critical++; }});
            });
            if (total > 0) {
                setTimeout(() => {
                    alert(`â˜€ï¸ Â¡Hola!\n\nAÃºn tienes ${total} tareas pendientes.\n${critical} son de prioridad CRÃTICA (roja).`);
                    localStorage.setItem('js5_last_notif', today);
                }, 800);
            }
        }
    },

    // --- LÃ“GICA DE ORDENAMIENTO (La clave de tu requerimiento) ---
    sortTasks(tasks) {
        return tasks.sort((a, b) => {
            // 1. Primero por prioridad (1 es menor que 2, por eso sube)
            if (a.priority !== b.priority) {
                return a.priority - b.priority;
            }
            // 2. Si tienen la misma prioridad, la mÃ¡s reciente primero (por ID/Tiempo)
            return b.id - a.id;
        });
    },

    editTask(id) {
        const task = this.tabs[this.activeTab].tasks.find(t => t.id === id);
        const newText = prompt("Editar tarea:", task.text);
        if (newText && newText.trim() !== "") {
            task.text = newText.trim();
            this.saveToStorage();
            this.renderContent();
        }
    },

    deleteTask(id) {
        if (confirm("Â¿Eliminar esta tarea definitivamente?")) {
            this.tabs[this.activeTab].tasks = this.tabs[this.activeTab].tasks.filter(t => t.id !== id);
            this.saveToStorage();
            this.renderTabs();
        }
    },

    updateProgress(id, val) {
        const task = this.tabs[this.activeTab].tasks.find(t => t.id === id);
        if (task) {
            task.progress = parseInt(val);
            if (val == 100) document.getElementById('audioSuccess').play();
        }
        this.saveToStorage();
        this.renderTabs(); // Renderizar pestaÃ±as para actualizar contador y contenido
    },

    renderTabs() {
        const container = document.getElementById('tabs');
        container.innerHTML = '';
        this.tabs.forEach((tab, i) => {
            const pendingCount = tab.tasks.filter(t => t.progress < 100).length;
            const btn = document.createElement('button');
            btn.className = `tab ${i === this.activeTab ? 'active' : ''}`;
            btn.innerHTML = `${tab.name} ${pendingCount > 0 ? `<span class="tab-count">${pendingCount}</span>` : ''}`;
            btn.onclick = () => { this.activeTab = i; this.renderTabs(); };
            container.appendChild(btn);
        });
        const addBtn = document.createElement('button');
        addBtn.className = 'tab';
        addBtn.style.background = '#27ae60';
        addBtn.innerHTML = '+';
        addBtn.onclick = () => this.addNewTab();
        container.appendChild(addBtn);
        this.renderContent();
    },

    renderContent() {
        const container = document.getElementById('content');
        const tasks = this.tabs[this.activeTab].tasks;
        
        // Aplicamos el ordenamiento antes de mostrar
        const pending = this.sortTasks(tasks.filter(t => t.progress < 100));
        const completed = this.sortTasks(tasks.filter(t => t.progress === 100));

        container.innerHTML = `
            <div class="input-group">
                <div class="priority-buttons">
                    ${[1,2,3].map(p => `<button class="priority-btn priority-btn-${p} ${this.selectedPriority === p ? 'selected' : ''}" onclick="App.selectedPriority=${p}; App.renderContent()"> ${p} </button>`).join('')}
                </div>
                <input type="text" id="taskInput" class="task-input" placeholder="Â¿QuÃ© hay que hacer?">
            </div>
            <button class="add-btn" onclick="App.addTask()">AGREGAR TAREA</button>
            
            <div id="taskList">
                ${pending.length === 0 && completed.length === 0 ? '<div class="no-tasks">No hay tareas en esta lista.</div>' : ''}
                ${pending.map(t => this.taskTemplate(t)).join('')}
                ${completed.length > 0 ? `<div class="separator"><span>Completadas</span></div>` : ''}
                ${completed.map(t => this.taskTemplate(t)).join('')}
            </div>
        `;

        document.getElementById('taskInput')?.focus();
        document.getElementById('taskInput')?.addEventListener('keypress', e => e.key === 'Enter' && this.addTask());
    },

    taskTemplate(t) {
        return `
            <div class="task priority-${t.priority}">
                <div class="task-bar" style="width: ${t.progress}%"></div>
                <div class="task-content">
                    <span class="task-text ${t.progress == 100 ? 'completed' : ''}">${t.text}</span>
                    <select class="task-progress" onchange="App.updateProgress(${t.id}, this.value)">
                        ${[0, 25, 50, 75, 100].map(v => `<option value="${v}" ${t.progress == v ? 'selected' : ''}>${v}%</option>`).join('')}
                    </select>
                    <button class="btn-action btn-edit" onclick="App.editTask(${t.id})">âœŽ</button>
                    <button class="btn-action btn-delete" onclick="App.deleteTask(${t.id})">Ã—</button>
                </div>
            </div>
        `;
    },

    addTask() {
        const input = document.getElementById('taskInput');
        if (!input.value.trim()) return;
        this.tabs[this.activeTab].tasks.push({
            id: Date.now(),
            text: input.value.trim(),
            priority: this.selectedPriority,
            progress: 0
        });
        this.saveToStorage();
        this.renderTabs(); // El renderTabs activarÃ¡ el renderContent con el nuevo orden
    },

    addNewTab() {
        const n = prompt("Nombre de la nueva lista:");
        if(n && n.trim() !== "") { 
            this.tabs.push({name: n.trim(), tasks: []}); 
            this.activeTab = this.tabs.length-1; 
            this.saveToStorage(); 
            this.renderTabs(); 
        }
    },

    updateDateTime() {
        const el = document.getElementById('datetime');
        if(el) {
            const options = { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' };
            el.innerText = new Date().toLocaleDateString('es-ES', options);
        }
    },

    saveToStorage() {
        localStorage.setItem('js5_smart_save', JSON.stringify({
            tabs: this.tabs, 
            activeTab: this.activeTab,
            isDarkMode: this.isDarkMode
        }));
    },

    loadFromStorage() {
        const data = JSON.parse(localStorage.getItem('js5_smart_save'));
        if(data) {
            this.tabs = data.tabs;
            this.activeTab = data.activeTab;
            this.isDarkMode = data.isDarkMode;
        }
    }
};

window.onload = () => App.init();
</script>
</body>
</html>
